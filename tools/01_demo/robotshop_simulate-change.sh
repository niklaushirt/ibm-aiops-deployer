#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# SIMULATE CHANGE RISK ON ROBOTSHOP
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


export APP_NAME=robot-shop
export SNOW_ID=dev44994

#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DO NOT MODIFY BELOW
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


clear

echo ""
echo ""
echo ""
echo ""
echo ""
echo "       ________  __  ___     ___    ________       "
echo "      /  _/ __ )/  |/  /    /   |  /  _/ __ \____  _____"
echo "      / // __  / /|_/ /    / /| |  / // / / / __ \/ ___/"
echo "    _/ // /_/ / /  / /    / ___ |_/ // /_/ / /_/ (__  ) "
echo "   /___/_____/_/  /_/    /_/  |_/___/\____/ .___/____/  "
echo "                                         /_/"
echo ""
echo ""
echo ""
echo ""
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo " ðŸš€  IBMAIOPS Simulate Change Risk for $APP_NAME"
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"


# Get Namespace from Cluster 
echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   ðŸ”¬ Getting Installation Namespace"
echo "   ------------------------------------------------------------------------------------------------------------------------------"

export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
echo "       âœ… OK - IBMAIOps:    $AIOPS_NAMESPACE"


# Define Log format
export log_output_path=/dev/null 2>&1
export TYPE_PRINT="ðŸ“ "$(echo $TYPE | tr 'a-z' 'A-Z')

#------------------------------------------------------------------------------------------------------------------------------------
#  Get Credentials
#------------------------------------------------------------------------------------------------------------------------------------
echo " "
echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "    ðŸš€  Initializing..."
echo "   ------------------------------------------------------------------------------------------------------------------------------"


echo "     ðŸ“› Select Namespace $AIOPS_NAMESPACE"
oc project $AIOPS_NAMESPACE  >/tmp/demo.log 2>&1  || true
echo " "

echo "     ðŸ“¥ Get Kafka Topics"
export KAFKA_TOPIC_CR=$(oc get kafkatopics -n $AIOPS_NAMESPACE | grep ibmaiops-cartridge.changerequest| awk '{print $1;}')

echo " "
echo "     ðŸ” Get Kafka Password"
export KAFKA_SECRET=$(oc get secret -n $AIOPS_NAMESPACE |grep 'aiops-kafka-secret'|awk '{print$1}')
export SASL_USER=$(oc get secret $KAFKA_SECRET -n $AIOPS_NAMESPACE --template={{.data.username}} | base64 --decode)
export SASL_PASSWORD=$(oc get secret $KAFKA_SECRET -n $AIOPS_NAMESPACE --template={{.data.password}} | base64 --decode)
export KAFKA_BROKER=$(oc get routes iaf-system-kafka-0 -n $AIOPS_NAMESPACE -o=jsonpath='{.status.ingress[0].host}{"\n"}'):443
echo " "

echo "     ðŸ“¥ Get Working Directories"
export WORKING_DIR_CR="./tools/01_demo/INCIDENT_FILES/$APP_NAME/changerisk"
echo " "



#------------------------------------------------------------------------------------------------------------------------------------
#  Get Kafkacat executable
#------------------------------------------------------------------------------------------------------------------------------------
echo "     ðŸ“¥  Getting Kafkacat executable"
if [ -x "$(command -v kafkacat)" ]; then
      export KAFKACAT_EXE=kafkacat
else
      if [ -x "$(command -v kcat)" ]; then
            export KAFKACAT_EXE=kcat
      else
            echo "     â— ERROR: kafkacat is not installed."
            echo "     âŒ Aborting..."
            exit 1
      fi
fi
echo " "

#------------------------------------------------------------------------------------------------------------------------------------
#  Get the cert for kafkacat
#------------------------------------------------------------------------------------------------------------------------------------
echo "     ðŸ¥‡ Getting Kafka Cert"
oc extract secret/kafka-secrets -n $AIOPS_NAMESPACE --keys=ca.crt --confirm  >/tmp/demo.log 2>&1  || true
echo "        âœ… OK"




#------------------------------------------------------------------------------------------------------------------------------------
#  Check Credentials
#------------------------------------------------------------------------------------------------------------------------------------
echo " "
echo " "
echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "    ðŸ”—  Checking credentials"
echo "   ------------------------------------------------------------------------------------------------------------------------------"


if [[ $KAFKA_TOPIC_CR == "" ]] ;
then
      echo " âŒ Kafka Topic for Change Risk not found. Aborting..."
      exit 1
else
      echo "     âœ… OK - Change Risk Topic"
fi


echo " "
echo " "
echo " "
echo " "



echo "   ----------------------------------------------------------------------------------------------------------------------------------------"
echo "     ðŸ”Ž  Parameters for Incident Simulation for $APP_NAME"
echo "   ----------------------------------------------------------------------------------------------------------------------------------------"
echo "     "
echo "       ðŸ—‚  CR Topic                    : $KAFKA_TOPIC_CR"
echo "       ðŸŒ Kafka Broker URL            : $KAFKA_BROKER"
echo "       ðŸ” Kafka User                  : $SASL_USER"
echo "       ðŸ” Kafka Password              : $SASL_PASSWORD"
echo "       ðŸ–¥ï¸  Kafka Executable            : $KAFKACAT_EXE"
echo "     "
echo "       ðŸ“‚ Directory for CR            : $WORKING_DIR_CR"
echo "   ----------------------------------------------------------------------------------------------------------------------------------------"
echo "   "
echo "   "
echo "   ----------------------------------------------------------------------------------------------------------------------------------------"
echo "    ðŸ—„ï¸  Change Risk Files to be loaded"
echo "   ----------------------------------------------------------------------------------------------------------------------------------------"
ls -1 $WORKING_DIR_CR | grep "json"
echo "     "



#------------------------------------------------------------------------------------------------------------------------------------
#  Inject the Data
#------------------------------------------------------------------------------------------------------------------------------------
echo "   -------------------------------------------------------------------------------------------------------------------------------------"
echo "    ðŸŒ  Injecting Data" 
echo "         Quit with Ctrl-Z"
echo "   -------------------------------------------------------------------------------------------------------------------------------------"
echo "     "
echo "     "

ACT_COUNT=0

rm $WORKING_DIR_CR/*.json-e  >/tmp/demo.log 2>&1  || true

FILES="$WORKING_DIR_CR/*.json" 

export NUM_FILES=$(ls $WORKING_DIR_CR| wc -l)

for TMPL_FILE in $FILES 
do 
      ACT_COUNT=`expr $ACT_COUNT + 1`

      export FILE=/tmp/temp_ticket.json
      cp $TMPL_FILE $FILE

      echo "     "
      echo "     "
      echo "      -------------------------------------------------------------------------------------------------------------------------------------"
      echo "       ðŸŒ  Injecting Data from File $FILE ($ACT_COUNT/$(($NUM_FILES)))" 
      echo "      -------------------------------------------------------------------------------------------------------------------------------------"
      echo "     "
      


      export TICKET_number_old=$(cat $FILE | jq ".data.number")
      export TICKET_number_only_old=$(cat $FILE | jq ".data.number"| cut -c7-11| tr -d ' ')
      #echo "Actual: $TICKET_number_old"
      #echo "Actual: $TICKET_number_only_old"

      export TICKET_number_only_new=$((TICKET_number_only_old+1))
      #echo "New: $TICKET_number_only_new"
      TICKET_number_new="CHG06$TICKET_number_only_new"
      #echo "New TI: $TICKET_number_new"
      sed -i -e "s/$TICKET_number_old/\"$TICKET_number_new\"/g" $FILE
      sed -i -e "s/$TICKET_number_old/\"$TICKET_number_new\"/g" $TMPL_FILE
      sed -i -e "s/dev99999/$SNOW_ID/g" $FILE

      export TICKET_number=$(cat $FILE | jq ".data.number")
      export TICKET_assigned_to=$(cat $FILE | jq ".data.assigned_to")
      export TICKET_short_description=$(cat $FILE | jq ".data.short_description")
      export TICKET_description=$(cat $FILE | jq ".data.description")
      export TICKET_instance=$(cat $FILE | jq ".data.instance")
      echo "        ----------------------------------------------------------------------------------------------------------------------------------------"
      echo "          ðŸ”Ž  Change to be injected"
      echo "        ----------------------------------------------------------------------------------------------------------------------------------------"
      echo "            ðŸ—‚  Ticket Number            : $TICKET_number"
      echo "            ðŸŒ Assigend To              : $TICKET_assigned_to"
      echo "            ðŸ“¥ Short Description        : $TICKET_short_description"
      echo "            ðŸ“¥ Description              : $TICKET_description"
      echo "            ðŸ“¥ SNOW INSTANCE            : $TICKET_instance"
      echo " "
      echo "        ----------------------------------------------------------------------------------------------------------------------------------------"

      #echo "          ${KAFKACAT_EXE} -v -X security.protocol=SASL_SSL -X ssl.ca.location=./ca.crt -X sasl.mechanisms=SCRAM-SHA-512  -X sasl.username=token -X sasl.password=$KAFKA_PASSWORD -b $KAFKA_BROKER -P -t $KAFKA_TOPIC_LOGS -l $FILE   "
      ${KAFKACAT_EXE} -v -X security.protocol=SASL_SSL -X ssl.ca.location=./ca.crt -X sasl.mechanisms=SCRAM-SHA-512  -X sasl.username=$SASL_USER -X sasl.password=$SASL_PASSWORD -b $KAFKA_BROKER -P -t $KAFKA_TOPIC_CR -l $FILE || true  >/tmp/demo.log 2>&1  || true
      
      echo "            âœ… OK"
      echo "        ----------------------------------------------------------------------------------------------------------------------------------------"
      echo "        "

      rm "$FILE-e"  >/tmp/demo.log 2>&1  || true
done



echo " "
echo " "
echo " "
echo " "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo " ðŸš€  IBMAIOPS Simulate Change Risk for $APP_NAME"
echo "  âœ…  Done..... "
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"

