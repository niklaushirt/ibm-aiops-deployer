
# *************************************************************************************************************************************************
# --------------------------------------------------------------------------------------------------------------------------------------
# Connection Details
# --------------------------------------------------------------------------------------------------------------------------------------
# *************************************************************************************************************************************************

- name: ðŸ›°ï¸  START - LOAD OVERLAY MERGE TOPOLOGY 
  debug: 
    msg="{{ lookup('pipe','date +%d.%m.%Y---%H:%M:%S') }}"



- name: Log
  shell: |
    export MESSAGE="Load Robotshop overlay Topology"
    export currentDate=$(date +%Y-%m-%d_%H:%M)
    echo "---------------------------------------------------------------------------------------------------------------------------------------------------" >> ../install_{{current_feature.kind}}.log
    echo $currentDate" - "$MESSAGE  >> ../install_{{current_feature.kind}}.log
  ignore_errors: true

- name: ðŸ“£ OCP CONSOLE - Create Openshift NOTIFICATION
  shell: |
    cat <<EOF | oc apply -f -
    apiVersion: console.openshift.io/v1
    kind: ConsoleNotification
    metadata:
      name: ibm-aiops-notification
    spec:
      backgroundColor: '#ffd500'
      color: '#000'
      location: {{global_config.position_ocp_notifications | default("BannerTop")}}
      text: 'Installing {{current_feature.kind}} - Load Robotshop overlay Topology'    
    EOF
  ignore_errors: true
  args:
    executable: /bin/bash
  when: global_config.create_ocp_notifications | default(true) == true  



# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
# LOAD TOPOLOGY CONFIGURATION
# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ðŸš€ TOPOLOGY - LOAD TOPOLOGY CONFIGURATION
  shell: |
    set -x
    
    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
    export TOPOLOGY_REST_USR=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 --decode)
    export TOPOLOGY_REST_PWD=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 --decode)
    export TOPO_MGT_ROUTE="https://"$(oc get route -n $AIOPS_NAMESPACE aiops-topology-topology -o jsonpath={.spec.host})
    export LOGIN="$TOPOLOGY_REST_USR:$TOPOLOGY_REST_PWD"
    export LOGIN_TOKEN=$(echo -n $LOGIN|base64)
    export TOPO_MGT_HOST=$(oc get route -n $AIOPS_NAMESPACE aiops-topology-topology -o jsonpath={.spec.host})

    echo "    HOST:         $TOPO_MGT_HOST"
    echo "    URL:          $TOPO_MGT_ROUTE/1.0/rest-observer/rest/resources"
    echo "    LOGIN:        $LOGIN"
    echo "    LOGIN_TOKEN:  $LOGIN_TOKEN"

    # kubectl exec -ti -n $AIOPS_NAMESPACE $(oc get po -n $AIOPS_NAMESPACE|grep topology-topology|awk '{print$1}') -- /opt/ibm/graph.tools/bin/backup_ui_config -out backup.json
    # kubectl cp -n $AIOPS_NAMESPACE $(oc get po -n $AIOPS_NAMESPACE|grep topology-topology|awk '{print$1}'):/opt/ibm/netcool/asm/data/tools/backup.json ./backup.json
    # open ./backup.json



    echo "Delete existing Topology Customization"
    curl -XGET -k \
    "$TOPO_MGT_ROUTE/1.0/topology/metadata?_field=*" \
    -H 'accept: application/json' \
    -H 'content-type: application/json' \
    -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
    -u $LOGIN|jq -r '._items[] | select(.maxLabelLength=="")|._id'>/tmp/customItems.json

    curl -XGET -k \
    "$TOPO_MGT_ROUTE/1.0/topology/metadata?_field=*" \
    -H 'accept: application/json' \
    -H 'content-type: application/json' \
    -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
    -u $LOGIN|jq -r '._items[] | select(.uniqueId=="globalSettings")|._id'>>/tmp/customItems.json  
    cat /tmp/customItems.json

    while read line; 
    do 
      echo "DELETE: $line"
      curl -XDELETE -k \
      "$TOPO_MGT_ROUTE/1.0/topology/metadata/$line" \
      -H 'accept: application/json' \
      -H 'content-type: application/json' \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -u $LOGIN
    done < /tmp/customItems.json




    echo "Upload Topology Customization"
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    if [[ "${OS}" == "darwin" ]]; then
          echo "MAC"
          TOPOLOGY_CUSTOM_FILE=$(pwd)"/roles/ibm-aiops-demo-content/templates/topology/asm_config.json"
    else
          TOPOLOGY_CUSTOM_FILE="{{role_path}}/templates/topology/asm_config.json"
    fi    

    cp $TOPOLOGY_CUSTOM_FILE /tmp/asm_config.json
    sed -i -e "s/MY_TOPO_URL/$TOPO_MGT_HOST/g" /tmp/asm_config.json
    sed -i -e "s/MY_TOKEN/$LOGIN_TOKEN/g" /tmp/asm_config.json


    kubectl cp /tmp/asm_config.json -n $AIOPS_NAMESPACE $(oc get po -n $AIOPS_NAMESPACE|grep topology-topology|awk '{print$1}'):/opt/ibm/netcool/asm/data/tools/asm_config.json 
    
    sleep 30 

    echo "Import Topology Customization"
    #kubectl exec -ti -n $AIOPS_NAMESPACE $(oc get po -n $AIOPS_NAMESPACE|grep topology-topology|awk '{print$1}') -- find /opt/ibm/netcool/asm/data/tools/
    kubectl exec -ti -n $AIOPS_NAMESPACE $(oc get po -n $AIOPS_NAMESPACE|grep topology-topology|awk '{print$1}') -- /opt/ibm/graph.tools/bin/import_ui_config -file asm_config.json

  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1
  #when: PRINT_LOGINS == true






# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
# FILE TOPOLOGY ROBOT SHOP
# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ðŸš€ TOPOLOGY - COPY OVERLAY TOPOLOGY TO POD ROBOTSHOP
  shell: |
    set -x
    
    echo "Create Custom Topology - Copy Topology to File Observer"

    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')


    # Get FILE_OBSERVER_POD
    FILE_OBSERVER_POD=$(oc get po -n $AIOPS_NAMESPACE -l app.kubernetes.io/instance=aiops-topology,app.kubernetes.io/name=file-observer -o jsonpath='{.items[0].metadata.name}')
    echo $FILE_OBSERVER_POD
    LOAD_FILE_NAME="robot-shop-file.txt"
    
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    if [[ "${OS}" == "darwin" ]]; then
          echo "MAC"
          FILE_OBSERVER_CAP=$(pwd)"/roles/ibm-aiops-demo-content/templates/topology/$LOAD_FILE_NAME"
    else
          FILE_OBSERVER_CAP="{{role_path}}/templates/topology/$LOAD_FILE_NAME"
    fi    
    echo $FILE_OBSERVER_POD
    echo $FILE_OBSERVER_CAP
    echo $TARGET_FILE_PATH
    TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"
    echo "  Copying capture file [${FILE_OBSERVER_CAP}] to file observer pod"
    echo "oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}"
    oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}
  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1
  #when: PRINT_LOGINS == true



- name: ðŸš€ TOPOLOGY - CREATE OVERLAY TOPOLOGY ROBOTSHOP
  shell: |
    set -x
    
    echo "Create Custom Topology - Create File Observer Job"


    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
    LOAD_FILE_NAME="robot-shop-file.txt"
    TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"



    # Get Credentials
    export TOPO_REST_USR=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 --decode)
    export TOPO_REST_PWD=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 --decode)
    export LOGIN="$TOPO_REST_USR:$TOPO_REST_PWD"

    export TOPO_ROUTE="https://"$(oc get route -n $AIOPS_NAMESPACE aiops-topology-file-observer -o jsonpath={.spec.host})
    export JOB_ID=robot-shop-topology

    echo "  URL: $TOPO_ROUTE"
    echo "  LOGIN: $LOGIN"


    # Get FILE_OBSERVER JOB
    curl -X "POST" "$TOPO_ROUTE/1.0/file-observer/jobs" --insecure \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -H "accept: application/json" \
      -H "Content-Type: application/json" \
      -u $LOGIN \
      -d "{
      \"unique_id\": \"${JOB_ID}\",
      \"description\": \"Automatically created by Nicks scripts\",
      \"parameters\": {
          \"file\": \"${TARGET_FILE_PATH}\"
          }
      }"


  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash
  
- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1




# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
# FILE TOPOLOGY SOCK SHOP
# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ðŸš€ TOPOLOGY - COPY OVERLAY TOPOLOGY TO POD SOCKSHOP
  shell: |
    set -x
    
    echo "Create Custom Topology - Copy Topology to File Observer"

    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')


    # Get FILE_OBSERVER_POD
    FILE_OBSERVER_POD=$(oc get po -n $AIOPS_NAMESPACE -l app.kubernetes.io/instance=aiops-topology,app.kubernetes.io/name=file-observer -o jsonpath='{.items[0].metadata.name}')
    echo $FILE_OBSERVER_POD
    LOAD_FILE_NAME="sock-shop-file.txt"
    
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    if [[ "${OS}" == "darwin" ]]; then
          echo "MAC"
          FILE_OBSERVER_CAP=$(pwd)"/roles/ibm-aiops-demo-content/templates/topology/$LOAD_FILE_NAME"
    else
          FILE_OBSERVER_CAP="{{role_path}}/templates/topology/$LOAD_FILE_NAME"
    fi    
    echo $FILE_OBSERVER_POD
    echo $FILE_OBSERVER_CAP
    echo $TARGET_FILE_PATH
    TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"
    echo "  Copying capture file [${FILE_OBSERVER_CAP}] to file observer pod"
    echo "oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}"
    oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}
  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1
  #when: PRINT_LOGINS == true



- name: ðŸš€ TOPOLOGY - CREATE OVERLAY TOPOLOGY SOCKSHOP
  shell: |
    set -x
    
    echo "Create Custom Topology - Create File Observer Job"


    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
    LOAD_FILE_NAME="sock-shop-file.txt"
    TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"



    # Get Credentials
    export TOPO_REST_USR=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 --decode)
    export TOPO_REST_PWD=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 --decode)
    export LOGIN="$TOPO_REST_USR:$TOPO_REST_PWD"

    export TOPO_ROUTE="https://"$(oc get route -n $AIOPS_NAMESPACE aiops-topology-file-observer -o jsonpath={.spec.host})
    export JOB_ID=sock-shop-topology

    echo "  URL: $TOPO_ROUTE"
    echo "  LOGIN: $LOGIN"


    # Get FILE_OBSERVER JOB
    curl -X "POST" "$TOPO_ROUTE/1.0/file-observer/jobs" --insecure \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -H "accept: application/json" \
      -H "Content-Type: application/json" \
      -u $LOGIN \
      -d "{
      \"unique_id\": \"${JOB_ID}\",
      \"description\": \"Automatically created by Nicks scripts\",
      \"parameters\": {
          \"file\": \"${TARGET_FILE_PATH}\"
          }
      }"


  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash
  
- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1


# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
# FILE TOPOLOGY ACME AIR
# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ðŸš€ TOPOLOGY - COPY OVERLAY TOPOLOGY TO POD ACME
  shell: |
    set -x
    
    echo "Create Custom Topology - Copy Topology to File Observer"

    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')


    # Get FILE_OBSERVER_POD
    FILE_OBSERVER_POD=$(oc get po -n $AIOPS_NAMESPACE -l app.kubernetes.io/instance=aiops-topology,app.kubernetes.io/name=file-observer -o jsonpath='{.items[0].metadata.name}')
    echo $FILE_OBSERVER_POD
    LOAD_FILE_NAME="acme-file.txt"
    
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    if [[ "${OS}" == "darwin" ]]; then
          echo "MAC"
          FILE_OBSERVER_CAP=$(pwd)"/roles/ibm-aiops-demo-content/templates/topology/$LOAD_FILE_NAME"
    else
          FILE_OBSERVER_CAP="{{role_path}}/templates/topology/$LOAD_FILE_NAME"
    fi    
    TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"
    echo $FILE_OBSERVER_POD
    echo $FILE_OBSERVER_CAP
    echo $TARGET_FILE_PATH
    echo "  Copying capture file [${FILE_OBSERVER_CAP}] to file observer pod"
    echo "oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}"
    oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}
  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1
  #when: PRINT_LOGINS == true





- name: ðŸš€ TOPOLOGY - CREATE OVERLAY TOPOLOGY ACME
  shell: |
    set -x
    
    echo "Create Custom Topology - Create File Observer Job"


    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
    LOAD_FILE_NAME="acme-file.txt"
    TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"



    # Get Credentials
    export TOPO_REST_USR=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 --decode)
    export TOPO_REST_PWD=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 --decode)
    export LOGIN="$TOPO_REST_USR:$TOPO_REST_PWD"

    export TOPO_ROUTE="https://"$(oc get route -n $AIOPS_NAMESPACE aiops-topology-file-observer -o jsonpath={.spec.host})
    export JOB_ID=acme-topology

    echo "  URL: $TOPO_ROUTE"
    echo "  LOGIN: $LOGIN"


    # Get FILE_OBSERVER JOB
    curl -X "POST" "$TOPO_ROUTE/1.0/file-observer/jobs" --insecure \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -H "accept: application/json" \
      -H "Content-Type: application/json" \
      -u $LOGIN \
      -d "{
      \"unique_id\": \"${JOB_ID}\",
      \"description\": \"Automatically created by Nicks scripts\",
      \"parameters\": {
          \"file\": \"${TARGET_FILE_PATH}\"
          }
      }"


  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash
  
- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1



# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
# FILE TOPOLOGY TELCO
# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ðŸš€ TOPOLOGY - COPY OVERLAY TOPOLOGY TO POD TELCO
  shell: |
    set -x
    
    echo "Create Custom Topology - Copy Topology to File Observer"

    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')


    # Get FILE_OBSERVER_POD
    FILE_OBSERVER_POD=$(oc get po -n $AIOPS_NAMESPACE -l app.kubernetes.io/instance=aiops-topology,app.kubernetes.io/name=file-observer -o jsonpath='{.items[0].metadata.name}')
    echo $FILE_OBSERVER_POD
    LOAD_FILE_NAME="telco-fiber-cut-ny-rchmd.txt"
    
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    if [[ "${OS}" == "darwin" ]]; then
          echo "MAC"
          FILE_OBSERVER_CAP=$(pwd)"/roles/ibm-aiops-demo-content/templates/topology/$LOAD_FILE_NAME"
    else
          FILE_OBSERVER_CAP="{{role_path}}/templates/topology/$LOAD_FILE_NAME"
    fi    
    TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"
    echo $FILE_OBSERVER_POD
    echo $FILE_OBSERVER_CAP
    echo $TARGET_FILE_PATH
    echo "  Copying capture file [${FILE_OBSERVER_CAP}] to file observer pod"
    echo "oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}"
    oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}
  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1
  #when: PRINT_LOGINS == true





- name: ðŸš€ TOPOLOGY - CREATE OVERLAY TOPOLOGY TELCO
  shell: |
    set -x
    
    echo "Create Custom Topology - Create File Observer Job"


    export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
    LOAD_FILE_NAME="telco-fiber-cut-ny-rchmd.txt"
    TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"



    # Get Credentials
    export TOPO_REST_USR=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 --decode)
    export TOPO_REST_PWD=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 --decode)
    export LOGIN="$TOPO_REST_USR:$TOPO_REST_PWD"

    export TOPO_ROUTE="https://"$(oc get route -n $AIOPS_NAMESPACE aiops-topology-file-observer -o jsonpath={.spec.host})
    export JOB_ID=telco-fiber-cut-ny-rchmd-topology

    echo "  URL: $TOPO_ROUTE"
    echo "  LOGIN: $LOGIN"


    # Get FILE_OBSERVER JOB
    curl -X "POST" "$TOPO_ROUTE/1.0/file-observer/jobs" --insecure \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -H "accept: application/json" \
      -H "Content-Type: application/json" \
      -u $LOGIN \
      -d "{
      \"unique_id\": \"${JOB_ID}\",
      \"description\": \"Automatically created by Nicks scripts\",
      \"parameters\": {
          \"file\": \"${TARGET_FILE_PATH}\"
          }
      }"


  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash
  
- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    verbosity: 1




- name: ðŸš€ TOPOLOGY - CREATE LONDON UNDERGROUND
  shell: |
    set -x

      export TOPOLOGY_NAME=london-underground
      cd ansible


      echo "----------------------------------------------------------------------------------------------------------"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸš€ TOPOLOGY - LOAD TOPOLOGY CONFIGURATION - $TOPOLOGY_NAME"
      echo "----------------------------------------------------------------------------------------------------------"


      export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
      export TOPO_REST_USR=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 --decode)
      export TOPO_REST_PWD=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 --decode)
      export TOPO_MGT_ROUTE="https://"$(oc get route -n $AIOPS_NAMESPACE aiops-topology-topology -o jsonpath={.spec.host})
      export LOGIN="$TOPO_REST_USR:$TOPO_REST_PWD"

      echo "    URL: $TOPO_MGT_ROUTE/1.0/rest-observer/rest/resources"
      echo "    LOGIN: $LOGIN"


      # echo "Delete existing Topology Customization"
      # curl -XGET -k \
      # "$TOPO_MGT_ROUTE/1.0/topology/metadata?_field=*" \
      # -H 'accept: application/json' \
      # -H 'content-type: application/json' \
      # -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      # -u $LOGIN|jq -r '._items[] | select(.maxLabelLength=="")|._id'>/tmp/customItems.json

      # cat /tmp/customItems.json

      # while read line; 
      # do 
      #   echo "DELETE: $line"
      #   curl -XDELETE -k \
      #   "$TOPO_MGT_ROUTE/1.0/topology/metadata/$line" \
      #   -H 'accept: application/json' \
      #   -H 'content-type: application/json' \
      #   -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      #   -u $LOGIN
      # done < /tmp/customItems.json



      echo "Upload Topology Customization"
      OS=$(uname -s | tr '[:upper:]' '[:lower:]')
      if [[ "${OS}" == "darwin" ]]; then
            echo "MAC"
            TOPOLOGY_CUSTOM_FILE=$(pwd)"/roles/ibm-aiops-demo-content/templates/topology/"$TOPOLOGY_NAME"-asm_config.json"
      else
            TOPOLOGY_CUSTOM_FILE="{{role_path}}/templates/topology/"$TOPOLOGY_NAME"-asm_config.json"
      fi    
      kubectl cp $TOPOLOGY_CUSTOM_FILE -n $AIOPS_NAMESPACE $(oc get po -n $AIOPS_NAMESPACE|grep topology-topology|awk '{print$1}'):/opt/ibm/netcool/asm/data/tools/"$TOPOLOGY_NAME"-asm_config.json 

      sleep 30 

      echo "Import Topology Customization"
      #kubectl exec -ti -n $AIOPS_NAMESPACE $(oc get po -n $AIOPS_NAMESPACE|grep topology-topology|awk '{print$1}') -- find /opt/ibm/netcool/asm/data/tools/
      kubectl exec -ti -n $AIOPS_NAMESPACE $(oc get po -n $AIOPS_NAMESPACE|grep topology-topology|awk '{print$1}') -- /opt/ibm/graph.tools/bin/import_ui_config -file $TOPOLOGY_NAME-asm_config.json




      echo "----------------------------------------------------------------------------------------------------------"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸš€ TOPOLOGY - COPY OVERLAY TOPOLOGY TO POD - $TOPOLOGY_NAME"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "Create Custom Topology - Copy Topology to File Observer"


      # Get FILE_OBSERVER_POD
      FILE_OBSERVER_POD=$(oc get po -n $AIOPS_NAMESPACE -l app.kubernetes.io/instance=aiops-topology,app.kubernetes.io/name=file-observer -o jsonpath='{.items[0].metadata.name}')
      echo $FILE_OBSERVER_POD
      LOAD_FILE_NAME=$TOPOLOGY_NAME"-file.txt"

      OS=$(uname -s | tr '[:upper:]' '[:lower:]')
      if [[ "${OS}" == "darwin" ]]; then
            echo "MAC"
            FILE_OBSERVER_CAP=$(pwd)"/roles/ibm-aiops-demo-content/templates/topology/$LOAD_FILE_NAME"
      else
            FILE_OBSERVER_CAP="{{role_path}}/templates/topology/$LOAD_FILE_NAME"
      fi    
      echo $FILE_OBSERVER_POD
      echo $FILE_OBSERVER_CAP
      echo $TARGET_FILE_PATH
      TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"
      echo "  Copying capture file [${FILE_OBSERVER_CAP}] to file observer pod"
      echo "oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}"
      oc cp -n $AIOPS_NAMESPACE ${FILE_OBSERVER_CAP} ${FILE_OBSERVER_POD}:${TARGET_FILE_PATH}






      echo "----------------------------------------------------------------------------------------------------------"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸš€ TOPOLOGY - CREATE OVERLAY TOPOLOGY - $TOPOLOGY_NAME"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "Create Custom Topology - Create File Observer Job"


      export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
      LOAD_FILE_NAME=$TOPOLOGY_NAME"-file.txt"
      TARGET_FILE_PATH="/opt/ibm/netcool/asm/data/file-observer/${LOAD_FILE_NAME}"


      # Get Credentials
      export TOPO_REST_USR=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 --decode)
      export TOPO_REST_PWD=$(oc get secret aiops-topology-asm-credentials -n $AIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 --decode)
      export LOGIN="$TOPO_REST_USR:$TOPO_REST_PWD"

      export TOPO_ROUTE="https://"$(oc get route -n $AIOPS_NAMESPACE aiops-topology-file-observer -o jsonpath={.spec.host})
      export JOB_ID=$TOPOLOGY_NAME"-topology"

      echo "  URL: $TOPO_ROUTE"
      echo "  LOGIN: $LOGIN"
      echo "  JOB_ID: $JOB_ID"


      # Get FILE_OBSERVER JOB
      curl -X "POST" "$TOPO_ROUTE/1.0/file-observer/jobs" --insecure \
        -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
        -H "accept: application/json" \
        -H "Content-Type: application/json" \
        -u $LOGIN \
        -d "{
        \"unique_id\": \"${JOB_ID}\",
        \"description\": \"Automatically created by Nicks scripts\",
        \"parameters\": {
            \"file\": \"${TARGET_FILE_PATH}\"
            }
        }"


      sleep 10


      # ----------------------------------------------------------------------------------------------------------
      # ----------------------------------------------------------------------------------------------------------
      # ðŸš€ TOPOLOGY - CREATE APPLICATION 
      # ----------------------------------------------------------------------------------------------------------
      # ----------------------------------------------------------------------------------------------------------

      export APP_NAME=underground-central

      echo "----------------------------------------------------------------------------------------------------------"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸš€ TOPOLOGY - CREATE APPLICATION - $APP_NAME"
      echo "----------------------------------------------------------------------------------------------------------"

      export APP_ID=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=keyIndexName%3D"$APP_NAME"-app" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)
      export TEMPLATE_ID_1=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=name%3DTube%20zone%201" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)
      export TEMPLATE_ID_2=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=name%3DTube%20zone%201%2B2" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)

      echo "    APP_ID:     "$APP_ID
      echo "    TEMPLATE_ID_1:"$TEMPLATE_ID_1
      echo "    TEMPLATE_ID_2:"$TEMPLATE_ID_2

      echo "Create Custom Topology - Create App"

      if [[ $APP_ID == "" ]];
      then    
        echo "  Creating Application"
        curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups" --insecure \
        -u $LOGIN \
        -H 'Content-Type: application/json' \
        -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
        -d '  {
            "keyIndexName": "'$APP_NAME'-app",
            "_correlationEnabled": "true",
            "iconId": "Underground",
            "businessCriticality": "Platinum",
            "vertexType": "group",
            "correlatable": "true",
            "disruptionCostPerMin": "200",
            "name": "Central London stations",
            "entityTypes": [
                "waiopsApplication"
            ],
            "tags": [
              "London",
              "underground"
            ]
        }
      '
      else
        echo "  Application already exists"
        echo "  Re-Creating Application"
        curl -X "DELETE" "$TOPO_MGT_ROUTE/1.0/topology/groups/$APP_ID" --insecure \
        -u $LOGIN \
        -H 'Content-Type: application/json' \
        -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'

        echo "  Creating Application"
        curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups" --insecure \
        -u $LOGIN \
        -H 'Content-Type: application/json' \
        -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
        -d '  {
            "keyIndexName": "'$APP_NAME'-app",
            "_correlationEnabled": "true",
            "iconId": "Underground",
            "businessCriticality": "Platinum",
            "vertexType": "group",
            "correlatable": "true",
            "disruptionCostPerMin": "200",
            "name": "Central London stations",
            "entityTypes": [
                "waiopsApplication"
            ],
            "tags": [
              "London",
              "underground"
            ]
        }
      '
      fi


      sleep 10


      export APP_ID=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=keyIndexName%3Dunderground-central-app" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)
      echo "    APP_ID:     "$APP_ID

      echo "----------------------------------------------------------------------------------------------------------"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸš€ ADD RESOURCES TO  APPLICATION- $APP_NAME"
      echo "----------------------------------------------------------------------------------------------------------"

      echo "  Add Template 1 Resources"
      curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups/$APP_ID/members" --insecure \
      -u $LOGIN \
      -H 'Content-Type: application/json' \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -d "{
        \"_id\": \"$TEMPLATE_ID_1\"
      }"

      echo "  Add Template 2 Resources"
      curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups/$APP_ID/members" --insecure \
      -u $LOGIN \
      -H 'Content-Type: application/json' \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -d "{
        \"_id\": \"$TEMPLATE_ID_2\"
      }"



      # ----------------------------------------------------------------------------------------------------------
      # ----------------------------------------------------------------------------------------------------------
      # ðŸš€ TOPOLOGY - CREATE APPLICATION 
      # ----------------------------------------------------------------------------------------------------------
      # ----------------------------------------------------------------------------------------------------------

      export APP_NAME=underground-inner

      echo "----------------------------------------------------------------------------------------------------------"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸš€ TOPOLOGY - CREATE APPLICATION - $APP_NAME"
      echo "----------------------------------------------------------------------------------------------------------"

      export APP_ID=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=keyIndexName%3D"$APP_NAME"-app" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)
      export TEMPLATE_ID_1=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=name%3DTube%20zone%202" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)
      export TEMPLATE_ID_2=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=name%3DTube%20zone%202%2B3" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)
      export TEMPLATE_ID_3=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=name%3DTube%20zone%202%2F3" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)

      echo "    APP_ID:     "$APP_ID
      echo "    TEMPLATE_ID_1:"$TEMPLATE_ID_1
      echo "    TEMPLATE_ID_2:"$TEMPLATE_ID_2
      echo "    TEMPLATE_ID_3:"$TEMPLATE_ID_3

      echo "Create Custom Topology - Create App"

      if [[ $APP_ID == "" ]];
      then    
        echo "  Creating Application"
        curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups" --insecure \
        -u $LOGIN \
        -H 'Content-Type: application/json' \
        -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
        -d '  {
            "keyIndexName": "'$APP_NAME'-app",
            "_correlationEnabled": "true",
            "iconId": "Underground",
            "businessCriticality": "Platinum",
            "vertexType": "group",
            "correlatable": "true",
            "disruptionCostPerMin": "200",
            "name": "Inner London stations",
            "entityTypes": [
                "waiopsApplication"
            ],
            "tags": [
              "London",
              "underground"
            ]
        }
      '
      else
        echo "  Application already exists"
        echo "  Re-Creating Application"
        curl -X "DELETE" "$TOPO_MGT_ROUTE/1.0/topology/groups/$APP_ID" --insecure \
        -u $LOGIN \
        -H 'Content-Type: application/json' \
        -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'

        echo "  Creating Application"
        curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups" --insecure \
        -u $LOGIN \
        -H 'Content-Type: application/json' \
        -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
        -d '  {
            "keyIndexName": "'$APP_NAME'-app",
            "_correlationEnabled": "true",
            "iconId": "Underground",
            "businessCriticality": "Platinum",
            "vertexType": "group",
            "correlatable": "true",
            "disruptionCostPerMin": "200",
            "name": "Central London stations",
            "entityTypes": [
                "waiopsApplication"
            ],
            "tags": [
              "London",
              "underground"
            ]
        }
      '
      fi


      sleep 10


      export APP_ID=$(curl -X "GET" "$TOPO_MGT_ROUTE/1.0/topology/groups?_field=*&_filter=keyIndexName%3D"$APP_NAME"-app" --insecure -u $LOGIN -H 'Content-Type: application/json' -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255'|jq -r -c '._items[]|._id'| tail -1)
      echo "    APP_ID:     "$APP_ID

      echo "----------------------------------------------------------------------------------------------------------"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸš€ ADD RESOURCES TO  APPLICATION- $APP_NAME"
      echo "----------------------------------------------------------------------------------------------------------"

      echo "  Add Template 1 Resources"
      curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups/$APP_ID/members" --insecure \
      -u $LOGIN \
      -H 'Content-Type: application/json' \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -d "{
        \"_id\": \"$TEMPLATE_ID_1\"
      }"

      echo "  Add Template 2 Resources"
      curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups/$APP_ID/members" --insecure \
      -u $LOGIN \
      -H 'Content-Type: application/json' \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -d "{
        \"_id\": \"$TEMPLATE_ID_2\"
      }"


      echo "  Add Template 3 Resources"
      curl -X "POST" "$TOPO_MGT_ROUTE/1.0/topology/groups/$APP_ID/members" --insecure \
      -u $LOGIN \
      -H 'Content-Type: application/json' \
      -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      -d "{
        \"_id\": \"$TEMPLATE_ID_3\"
      }"


      sleep 10


      echo "----------------------------------------------------------------------------------------------------------"
      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸš€ CREATE POLICIES - $APP_NAME"
      echo "----------------------------------------------------------------------------------------------------------"
      export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')

      export POLICY_USERNAME=$(oc get secret -n $AIOPS_NAMESPACE aiops-ir-lifecycle-policy-registry-svc -o jsonpath='{.data.username}' | base64 --decode)
      export POLICY_PASSWORD=$(oc get secret -n $AIOPS_NAMESPACE aiops-ir-lifecycle-policy-registry-svc -o jsonpath='{.data.password}' | base64 --decode)
      export POLICY_LOGIN="$POLICY_USERNAME:$POLICY_PASSWORD"
      echo "POLICY_LOGIN: "$POLICY_LOGIN

      oc create route passthrough --insecure-policy="Redirect" policy-api -n $AIOPS_NAMESPACE --service aiops-ir-lifecycle-policy-registry-svc --port ssl-port


      export POLICY_ROUTE=""
      while [[ $POLICY_ROUTE == "" ]]; do
        export POLICY_ROUTE=$(oc get routes -n $AIOPS_NAMESPACE policy-api -o jsonpath="{['spec']['host']}")
      done
      echo "POLICY_ROUTE: "$POLICY_ROUTE


      # export POLICY_ID=london-underground-high
      # export POLICY_NAME="DEMO London-Underground - No service"

      # echo "----------------------------------------------------------------------------------------------------------"
      # echo "ðŸ› ï¸  POLICIES - Create Incident Creation Policy - $POLICY_NAME"

      # echo "Upload Topology Customization"
      # OS=$(uname -s | tr '[:upper:]' '[:lower:]')
      # if [[ "${OS}" == "darwin" ]]; then
      #       echo "MAC"
      #       POLICY_FILE=$(pwd)"/roles/ibm-aiops-demo-content/templates/policies/"$POLICY_ID"-incident-creation-policy.json"
      # else
      #       POLICY_FILE="{{role_path}}/templates/policies/"$POLICY_ID"-incident-creation-policy.json"
      # fi    

      # echo $POLICY_FILE
      # cp $POLICY_FILE /tmp/incident_policy.json


      # export result=$(curl -XGET -k -s "https://$POLICY_ROUTE/policyregistry.ibm-netcool-prod.aiops.io/v1alpha/system/cfd95b7e-3bc7-4006-a4a8-a73a79c71255/"  \
      #     -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      #     -H 'content-type: application/json' \
      #     -u $POLICY_LOGIN|grep "$POLICY_NAME"|wc -l|tr -d ' ')

      # if [[ $result == "0" ]]; then
      #     export result="Create Incident Creation Policy "
      #     export result=$(curl -XPOST -k -s "https://$POLICY_ROUTE/policyregistry.ibm-netcool-prod.aiops.io/v1alpha/system/cfd95b7e-3bc7-4006-a4a8-a73a79c71255/policies"  \
      #     -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      #     -H 'content-type: application/json' \
      #     -u $POLICY_LOGIN \
      #     -d @/tmp/incident_policy.json)
      # else 
      #     export result="Already exists"
      # fi 
      # echo $result




      # export POLICY_ID=london-underground-med
      # export POLICY_NAME="DEMO London-Underground - Severe delays"

      # echo "----------------------------------------------------------------------------------------------------------"
      # echo "ðŸ› ï¸  POLICIES - Create Incident Creation Policy - $POLICY_NAME"

      # echo "Upload Topology Customization"
      # OS=$(uname -s | tr '[:upper:]' '[:lower:]')
      # if [[ "${OS}" == "darwin" ]]; then
      #       echo "MAC"
      #       POLICY_FILE=$(pwd)"/roles/ibm-aiops-demo-content/templates/policies/"$POLICY_ID"-incident-creation-policy.json"
      # else
      #       POLICY_FILE="{{role_path}}/templates/policies/"$POLICY_ID"-incident-creation-policy.json"
      # fi    

      # echo $POLICY_FILE
      # cp $POLICY_FILE /tmp/incident_policy.json


      # export result=$(curl -XGET -k -s "https://$POLICY_ROUTE/policyregistry.ibm-netcool-prod.aiops.io/v1alpha/system/cfd95b7e-3bc7-4006-a4a8-a73a79c71255/"  \
      #     -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      #     -H 'content-type: application/json' \
      #     -u $POLICY_LOGIN|grep "$POLICY_NAME"|wc -l|tr -d ' ')

      # if [[ $result == "0" ]]; then
      #     export result="Create Incident Creation Policy "
      #     export result=$(curl -XPOST -k -s "https://$POLICY_ROUTE/policyregistry.ibm-netcool-prod.aiops.io/v1alpha/system/cfd95b7e-3bc7-4006-a4a8-a73a79c71255/policies"  \
      #     -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      #     -H 'content-type: application/json' \
      #     -u $POLICY_LOGIN \
      #     -d @/tmp/incident_policy.json)
      # else 
      #     export result="Already exists"
      # fi 
      # echo $result





      # export POLICY_ID=london-underground-low
      # export POLICY_NAME="DEMO London-Underground - Catch All"

      # echo "----------------------------------------------------------------------------------------------------------"
      # echo "ðŸ› ï¸  POLICIES - Create Incident Creation Policy - $POLICY_NAME"

      # echo "Upload Topology Customization"
      # OS=$(uname -s | tr '[:upper:]' '[:lower:]')
      # if [[ "${OS}" == "darwin" ]]; then
      #       echo "MAC"
      #       POLICY_FILE=$(pwd)"/roles/ibm-aiops-demo-content/templates/policies/"$POLICY_ID"-incident-creation-policy.json"
      # else
      #       POLICY_FILE="{{role_path}}/templates/policies/"$POLICY_ID"-incident-creation-policy.json"
      # fi    

      # echo $POLICY_FILE
      # cp $POLICY_FILE /tmp/incident_policy.json


      # export result=$(curl -XGET -k -s "https://$POLICY_ROUTE/policyregistry.ibm-netcool-prod.aiops.io/v1alpha/system/cfd95b7e-3bc7-4006-a4a8-a73a79c71255/"  \
      #     -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      #     -H 'content-type: application/json' \
      #     -u $POLICY_LOGIN|grep "$POLICY_NAME"|wc -l|tr -d ' ')

      # if [[ $result == "0" ]]; then
      #     export result="Create Incident Creation Policy "
      #     export result=$(curl -XPOST -k -s "https://$POLICY_ROUTE/policyregistry.ibm-netcool-prod.aiops.io/v1alpha/system/cfd95b7e-3bc7-4006-a4a8-a73a79c71255/policies"  \
      #     -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
      #     -H 'content-type: application/json' \
      #     -u $POLICY_LOGIN \
      #     -d @/tmp/incident_policy.json)
      # else 
      #     export result="Already exists"
      # fi 
      # echo $result




      export POLICY_ID=london-underground-scope-based-grouping
      export POLICY_NAME="DEMO London-Underground - Scope Grouping"

      echo "----------------------------------------------------------------------------------------------------------"
      echo "ðŸ› ï¸  POLICIES - Create Scope Policy - $POLICY_NAME"

      OS=$(uname -s | tr '[:upper:]' '[:lower:]')
      if [[ "${OS}" == "darwin" ]]; then
            echo "MAC"
            POLICY_FILE=$(pwd)"/roles/ibm-aiops-demo-content/templates/policies/"$POLICY_ID".json"
      else
            POLICY_FILE="{{role_path}}/templates/policies/"$POLICY_ID".json"
      fi    

      echo $POLICY_FILE
      cp $POLICY_FILE /tmp/incident_policy.json


      export result=$(curl -XGET -k -s "https://$POLICY_ROUTE/policyregistry.ibm-netcool-prod.aiops.io/v1alpha/system/cfd95b7e-3bc7-4006-a4a8-a73a79c71255/"  \
          -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
          -H 'content-type: application/json' \
          -u $POLICY_LOGIN|grep "$POLICY_NAME"|wc -l|tr -d ' ')

      if [[ $result == "0" ]]; then
          export result="Create Incident Creation Policy "
          export result=$(curl -XPOST -k -s "https://$POLICY_ROUTE/policyregistry.ibm-netcool-prod.aiops.io/v1alpha/system/cfd95b7e-3bc7-4006-a4a8-a73a79c71255/policies"  \
          -H 'X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255' \
          -H 'content-type: application/json' \
          -u $POLICY_LOGIN \
          -d @/tmp/incident_policy.json)
      else 
          export result="Already exists"
      fi 
      echo $result

  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash
  
- name: ðŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    #verbosity: 1





# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
# Probable Cause Hack for 4.3 
# --------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------------
# - name: ðŸš€ TOPOLOGY - Probable Cause Hack for 4.3  
#   shell: |
#     set -x
    
#     # 61654
#     echo "***************************************************************************************************************************************************"
#     echo "***************************************************************************************************************************************************"
#     echo "                                                                                                                                                   "
#     echo " ðŸš€ Topology Probable Cause Hack for 4.3                                                                                                                                              "
#     echo "                                                                                                                                                   "
#     echo "***************************************************************************************************************************************************"


#     echo "ðŸŒ GET ZEN TOKEN"

#     export AIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')
#     echo "       ðŸ› ï¸   Get Route"
#     export ROUTE=$(oc get route -n $AIOPS_NAMESPACE cpd  -o jsonpath={.spec.host})          
#     echo "        Route: $ROUTE"
#     echo ""

#     echo "       ðŸ› ï¸   Getting ZEN Token"
  
#     ZEN_API_HOST=$(oc get route -n $AIOPS_NAMESPACE cpd -o jsonpath='{.spec.host}')
#     ZEN_LOGIN_URL="https://${ZEN_API_HOST}/v1/preauth/signin"
#     LOGIN_USER=admin
#     LOGIN_PASSWORD="$(oc get secret admin-user-details -n $AIOPS_NAMESPACE -o jsonpath='{ .data.initial_admin_password }' | base64 --decode)"

#     ZEN_LOGIN_RESPONSE=$(
#     curl -k \
#     -H 'Content-Type: application/json' \
#     -XPOST \
#     "${ZEN_LOGIN_URL}" \
#     -d '{
#           "username": "'"${LOGIN_USER}"'",
#           "password": "'"${LOGIN_PASSWORD}"'"
#     }' 2> /dev/null
#     )

#     ZEN_LOGIN_MESSAGE=$(echo "${ZEN_LOGIN_RESPONSE}" | jq -r .message)

#     if [ "${ZEN_LOGIN_MESSAGE}" != "success" ]; then
#     echo "Login failed: ${ZEN_LOGIN_MESSAGE}" 1>&2

#     exit 2
#     fi

#     ZEN_TOKEN=$(echo "${ZEN_LOGIN_RESPONSE}" | jq -r .token)
#     echo "${ZEN_TOKEN}"

#     echo "Sucessfully logged in" 1>&2

#     echo "ðŸš€ Patch Topology Probable Cause"

#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "accesses", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "calls", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "exposedBy", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "runsOn", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "federates", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "has", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "bakerloo", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "central", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "circle", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "district", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "dlr", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "hammersmith-city", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "jubilee", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "london-overground", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "metropolitan", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "northern", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "piccadilly", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "routesVia", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "victoria", "label": "association", "outdegree": 20,"indegree": 5}]}'
#     curl -s -k -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" -d '{"edge_type_list":[{ "edge": "waterloo-city", "label": "association", "outdegree": 20,"indegree": 5}]}'

#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep accesses
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep calls
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep exposedBy
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep runsOn
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep federates
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep has
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep bakerloo
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep central
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep circle
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep district
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep dlr
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep hammersmith-city
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep jubilee
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep london-overground
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep metropolitan
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep northern
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep piccadilly
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep routesVia
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep victoria
#     curl  -k -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${ZEN_TOKEN}" https://$ROUTE/aiops/api/issue-resolution/mime/v1/customisation/edge_type -H "X-TenantID: cfd95b7e-3bc7-4006-a4a8-a73a79c71255" | jq | grep waterloo-city

#     oc scale deploy aiops-ir-analytics-probablecause --replicas=0
#     oc scale deploy aiops-ir-analytics-probablecause --replicas=1


#   register: output_string
#   ignore_errors: true
#   args:
#     executable: /bin/bash

# - name: ðŸŸ£  OUTPUT
#   debug: 
#     var: output_string.stdout_lines
#     verbosity: 1
#   #when: PRINT_LOGINS == true


