
# *************************************************************************************************************************************************
# --------------------------------------------------------------------------------------------------------------------------------------
# Install Turbonomic
# --------------------------------------------------------------------------------------------------------------------------------------
# *************************************************************************************************************************************************

# --------------------------------------------------------------------------------------------------------------------------------------
# Install Turbonomic Demo Content
# --------------------------------------------------------------------------------------------------------------------------------------

- name: üõ∞Ô∏è  START - INSTALL TURBONOMIC
  debug: 
    msg="{{ lookup('pipe','date +%d.%m.%Y---%H:%M:%S') }}"


- name: Log
  shell: |
    export MESSAGE="Installing TURBONOMIC Demo Content"
    export currentDate=$(date +%Y-%m-%d_%H:%M)
    echo "---------------------------------------------------------------------------------------------------------------------------------------------------" >> ../install_{{current_feature.kind}}.log
    echo $currentDate" - "$MESSAGE  >> ../install_{{current_feature.kind}}.log
  ignore_errors: true

- name: üì£ OCP CONSOLE - Create Openshift NOTIFICATION
  shell: |
    cat <<EOF | oc apply -f -
    apiVersion: console.openshift.io/v1
    kind: ConsoleNotification
    metadata:
      name: ibm-aiops-notification-status
    spec:
      backgroundColor: '#ffd500'
      color: '#000'
      location: {{global_config.position_ocp_notifications | default("BannerTop")}}
      text: 'Installing {{current_feature.kind}} - Demo Content'    
    EOF
  ignore_errors: true
  args:
    executable: /bin/bash
  when: global_config.create_ocp_notifications | default(true) == true  


- name: üöÄ TURBONOMIC - Set ADMIN Password 
  set_fact: current_admin_pass={{current_feature.turbo_admin_password  | default( global_config.global_password )}}


- name: üü£  TURBONOMIC -  ADMIN Password {{current_admin_pass}}
  debug:
    var: current_admin_pass
    verbosity: 1


- name: üöÄ TURBONOMIC - Set DEMO Password 
  set_fact: current_demo_pass={{current_feature.turbo_admin_password  | default( global_config.global_password )}}


- name: üü£  TURBONOMIC -  DEMO Password {{current_demo_pass}}
  debug:
    var: current_demo_pass
    verbosity: 1




- name: üöÄ TURBONOMIC - Get ROUTE
  shell: |
    export TURBO_URL=$(oc get route -n turbonomic nginx -o jsonpath={.spec.host})
    echo $TURBO_URL
  ignore_errors: true
  register: output
        
- name: üöÄ TURBONOMIC - Set ROUTE - {{ output.stdout_lines }} 
  set_fact: TURBO_URL={{ output.stdout_lines[0] }} 


- name: üöÄ TURBONOMIC - Init Admin
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Initialization"
    export TURBO_PASSWORD={{current_admin_pass}}
    export TURBO_URL={{TURBO_URL}}

    result=$(curl -XPOST -s -k -c /tmp/cookies -H 'accept: application/json' "https://{{TURBO_URL}}/api/v3/initAdmin" -d "username=administrator&password=$TURBO_PASSWORD")
    echo $result
    result=$(curl -XPOST -s -k -c /tmp/cookies -H 'accept: application/json' "https://{{TURBO_URL}}/api/v3/login?disable_hateoas=true" -d "username=administrator&password=$TURBO_PASSWORD")
    echo $result

  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
        




- name: üöÄ TURBONOMIC - Login
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Initialization"
    export TURBO_PASSWORD={{current_admin_pass}}
    export TURBO_URL={{TURBO_URL}}

    while [[ `curl -XPOST -s -k -c /tmp/cookies -H 'accept: application/json' "https://{{TURBO_URL}}/api/v3/login?hateoas=true" -d "username=administrator&password=$TURBO_PASSWORD"` =~ "InvalidCredentialsException" ]]
    do
      echo "Waiting for Turbo Init"
      sleep 15
    done
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
        




# --------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------
# LOAD LICENSE IF PROVIDED
# --------------------------------------------------------------------------------------------------------
- name: üöÄ TURBONOMIC - Add License if provided
  shell: |
    export TURBO_URL={{TURBO_URL}}

    echo "{{current_turbo_license | default("NONE") }}" > /tmp/license.lic
    #cat /tmp/license.lic
    
    result=$(curl -XPOST -k -b /tmp/cookies -H 'Content-Type: multipart/form-data'  -H 'accept: application/json' "https://$TURBO_URL/api/v3/licenses?dryRun=false" -F 'file=@/tmp/license.lic')
 
    echo $result
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_turbo_license | default("NONE") != "NONE"
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 2
  when: current_turbo_license | default("NONE") != "NONE"





# --------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------
# CREATE DEMO USER
# --------------------------------------------------------------------------------------------------------


- name: üöÄ TURBONOMIC - Create demo User
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create demo User"
    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/users" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '  {
      "displayName": "Demo User",
        "username": "{{current_feature.demo_user}}",
        "password": "{{current_demo_pass}}",
        "roles": [
          {
            "name": "ADMINISTRATOR"
          }
        ],
        "loginProvider": "Local",
        "type": "DedicatedCustomer",
        "showSharedUserSC": false
      }
      ')
    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.create_user == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.create_user == true



# --------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------
# CREATE GROUPS
# --------------------------------------------------------------------------------------------------------
- name: üöÄ TURBONOMIC - Create Group vSphere VMs
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create demo User"
    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '  
      {
        "displayName": "vSphere VMs",
        "className": "Group",
        "groupType": "VirtualMachine",
        "environmentType": "ONPREM",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [
          {
            "expVal": "vCenter",
            "expType": "EQ",
            "filterType": "vmByTargetType",
            "caseSensitive": false,
            "entityType": null,
            "singleLine": false
          }
        ],
        "temporary": false,
        "memberTypes": [
          "VirtualMachine"
        ],
        "entityTypes": [
          "VirtualMachine"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
    
      ')
    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.group_vcenter_vms == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.group_vcenter_vms == true



- name: üöÄ TURBONOMIC - Create Group Azure VMs
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create demo User"
    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '  
      {
        "displayName": "Azure VMs",
        "className": "Group",
        "groupType": "VirtualMachine",
        "environmentType": "ONPREM",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [{
            "expVal": "AZURE",
            "expType": "EQ",
            "filterType": "vmsByCloudProvider",
            "caseSensitive": false,
            "entityType": null,
            "singleLine": false
        }],
        "temporary": false,
        "memberTypes": [
          "VirtualMachine"
        ],
        "entityTypes": [
          "VirtualMachine"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
    
      ')
    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.group_vcenter_vms == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.group_vcenter_vms == true



- name: üöÄ TURBONOMIC - Create Group AWS VMs
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create demo User"
    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '  
      {
        "displayName": "AWS VMs",
        "className": "Group",
        "groupType": "VirtualMachine",
        "environmentType": "ONPREM",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [{
            "expVal": "AWS",
            "expType": "EQ",
            "filterType": "vmsByCloudProvider",
            "caseSensitive": false,
            "entityType": null,
            "singleLine": false
        }],
        "temporary": false,
        "memberTypes": [
          "VirtualMachine"
        ],
        "entityTypes": [
          "VirtualMachine"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
    
      ')
    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.group_vcenter_vms == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.group_vcenter_vms == true


- name: üöÄ TURBONOMIC - Create Group Google VMs
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create demo User"
    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '  
      {
        "displayName": "Google VMs",
        "className": "Group",
        "groupType": "VirtualMachine",
        "environmentType": "ONPREM",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [{
            "expVal": "GCP",
            "expType": "EQ",
            "filterType": "vmsByCloudProvider",
            "caseSensitive": false,
            "entityType": null,
            "singleLine": false
        }],
        "temporary": false,
        "memberTypes": [
          "VirtualMachine"
        ],
        "entityTypes": [
          "VirtualMachine"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
    
      ')
    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.group_vcenter_vms == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.group_vcenter_vms == true


- name: üöÄ TURBONOMIC - Create Group Kubernetes VMs
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create demo User"
    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '  
      {
        "displayName": "Kubernetes VMs",
        "className": "Group",
        "groupType": "VirtualMachine",
        "environmentType": "ONPREM",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [
          {
            "expVal": "Kubernetes",
            "expType": "EQ",
            "filterType": "vmByTargetType",
            "caseSensitive": false,
            "entityType": null,
            "singleLine": false
          }
        ],
        "temporary": false,
        "memberTypes": [
          "VirtualMachine"
        ],
        "entityTypes": [
          "VirtualMachine"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
    
      ')
    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.group_vcenter_vms == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.group_vcenter_vms == true



- name: üöÄ TURBONOMIC - Create Group RobotShop AppComponents
  shell: |
    result=$(curl -s -k -X 'POST' \
      "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies\
      -H 'accept: application/json' \
      -H 'Content-Type: application/json' \
      -d '  
      {
        "displayName": "RobotShopSynthetic AppComponents",
        "className": "Group",
        "groupType": "ApplicationComponent",
        "severity": "NORMAL",
        "environmentType": "HYBRID",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [
          {
            "expVal": ".*robot.*",
            "expType": "RXEQ",
            "filterType": "appCompsByName",
            "caseSensitive": false,
            "entityType": null,
            "singleLine": false
          }
        ],
        "temporary": false,
        "cloudType": "UNKNOWN",
        "memberTypes": [
          "ApplicationComponent"
        ],
        "entityTypes": [
          "ApplicationComponent"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
      ')

    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.group_robotshop == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.group_robotshop == true





- name: üöÄ TURBONOMIC - Create Licensing Groups
  shell: |
    result=$(curl -s -k -X 'POST' \
      "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies\
      -H 'accept: application/json' \
      -H 'Content-Type: application/json' \
      -d ' {
        "displayName": "_DB_LICENSED_HOST",
        "className": "Group",
        "groupType": "PhysicalMachine",
        "severity": "CRITICAL",
        "environmentType": "ONPREM",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [
          {
            "expVal": "192.168.10.87",
            "expType": "RXEQ",
            "filterType": "pmsByName",
            "caseSensitive": false,
            "entityType": null,
            "singleLine": false
          }
        ],
        "temporary": false,
        "cloudType": "UNKNOWN",
        "memberTypes": [
          "PhysicalMachine"
        ],
        "entityTypes": [
          "PhysicalMachine"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
      
      ')

    echo $result|jq -r ".displayName"| sed 's/^/     /'
    export sellerUuid=$(echo $result|jq -r ".uuid")
    echo "sellerUuid: $sellerUuid"
    echo ""



    result=$(curl -s -k -X 'POST' \
      "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies\
      -H 'accept: application/json' \
      -H 'Content-Type: application/json' \
      -d '   {
        "displayName": "_DB_VMs",
        "className": "Group",
        "groupType": "VirtualMachine",
        "severity": "NORMAL",
        "environmentType": "HYBRID",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [
          {
            "expVal": ".*mysql.*|.*demo.*|.*backend.*",
            "expType": "RXEQ",
            "filterType": "vmsByName",
            "caseSensitive": false,
            "entityType": null,
            "singleLine": false
          }
        ],
        "temporary": false,
        "cloudType": "HYBRID",
        "memberTypes": [
          "VirtualMachine"
        ],
        "entityTypes": [
          "VirtualMachine"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
      ')

    echo $result|jq -r ".displayName"| sed 's/^/     /'
    export buyerUuid=$(echo $result|jq -r ".uuid")
    echo "buyerUuid: $buyerUuid"
    echo ""


    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üöÄ Creating License Policy"
    echo "      sellerUuid: $sellerUuid"
    echo "      buyerUuid: $buyerUuid"



    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/markets/777777/policies" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '
    {
      "policyName": "_DB_LICENSE",
      "type": "BIND_TO_GROUP_AND_LICENSE",
      "sellerUuid": "'$sellerUuid'",
      "buyerUuid": "'$buyerUuid'",
      "mergeUuids": [
      
      ],
      "mergeType": "Cluster",
      "capacity": 4,
      "enabled": true,
      "providerEntityType": "Application"
    }')

    echo $result|jq -r ".displayName"| sed 's/^/     /'
    echo ""




    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/markets/777777/policies" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '
    {
      "policyName": "_DB_PLACE",
      "type": "AT_MOST_N_BOUND",
      "capacity": 4,
      "sellerUuid": "'$sellerUuid'",
      "buyerUuid": "'$buyerUuid'",
      "mergeUuids": [
      
      ],
      "mergeType": "Cluster",
      "capacity": 4,
      "enabled": true,
      "providerEntityType": "Application"
    }')

    echo $result|jq -r ".displayName"| sed 's/^/     /'
    echo ""



  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.group_licensing == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.group_licensing == true






- name: üöÄ TURBONOMIC - Create Schedule and Maintenance Policy
  shell: |
    result=$(curl -s -k -X 'POST' \
      "https://{{TURBO_URL}}/api/v3/schedules" -b /tmp/cookies \
      -H 'accept: application/json' \
      -H 'Content-Type: application/json' \
      -d '  
        {
          "displayName": "MaintenanceFirstSaturdayOfMonth",
          "startTime": "2023-03-29T01:30",
          "endTime": "2023-03-29T02:30",
          "recurrence": {
            "type": "MONTHLY",
            "daysOfWeek": [
              "Sat"
            ],
            "weekOfTheMonth": [
              1
            ],
            "interval": 1
          },
          "timeZone": "Europe/Paris"
        }
      ')

    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.group_robotshop == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.group_robotshop == true





# --------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------
# CREATE TARGETS
# --------------------------------------------------------------------------------------------------------


# - name: üöÄ TURBONOMIC - Create Instana Target
#   shell: |
#     echo "------------------------------------------------------------------------------------------------------------------------------"
#     echo " üì• Create Instana Target"
#     INSTANA_IP=$(oc get route -n instana-core dev-aiops -o jsonpath={.spec.host})
#     result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/targets" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '{
#         "uuid": "74709474070544",
#         "displayName": "159.122.143.166",
#         "category": "Applications and Databases",
#         "inputFields": [
#           {
#             "name": "apiToken",
#             "value": "ChangeMe"
#           },
#           {
#             "name": "address",
#             "value": "'$INSTANA_IP'"
#           },
#           {
#             "name": "collectVmMetrics",
#             "value": "false"
#           }
#         ],
#         "type": "Instana",
#         "readonly": false
#       }')

#     echo $result
#     echo ""
#     echo ""
#   ignore_errors: true
#   register: output
#   args:
#     executable: /bin/bash
#   when: current_feature.target_instana == true
# - name: üü£  OUTPUT
#   debug:
#     var: output.stdout_lines
#     verbosity: 1
#   when: current_feature.target_instana == true





# --------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------
# DEPLOY DIF METRICS ROBOTSHOP
# --------------------------------------------------------------------------------------------------------


- name: üöÄ TURBONOMIC - Create RobotShop BusinessApp
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create demo User"
    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/topologydefinitions" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d '  
    {
      "uuid": "285815442727328",
      "displayName": "RobotShopSynthetic",
      "contextBased": true,
      "entityType": "BusinessApplication",
      "entityDefinitionData": {
        "manualConnectionData": {
          "Service": {
            "dynamicConnectionCriteria": [{
              "expVal": ".*robot.*",
              "expType": "RXEQ",
              "filterType": "servicesByName",
              "caseSensitive": false,
              "entityType": null,
              "singleLine": false
            }]
          },
          "Namespace": {
            "dynamicConnectionCriteria": [{
              "expVal": ".*robot.*",
              "expType": "RXEQ",
              "filterType": "namespacesByName",
              "caseSensitive": false,
              "entityType": null,
              "singleLine": false
            }]
          },
          "VirtualMachine": {
            "dynamicConnectionCriteria": [{
              "expVal": ".*demo.*|.*robot.*",
              "expType": "RXEQ",
              "filterType": "vmsByName",
              "caseSensitive": false,
              "entityType": null,
              "singleLine": false
            }]
          },
          "ApplicationComponent": {
            "dynamicConnectionCriteria": [{
              "expVal": "*.robot.*",
              "expType": "RXEQ",
              "filterType": "appCompsByName",
              "caseSensitive": false,
              "entityType": null,
              "singleLine": false
            }]
          }
        }
      }
    }

      ')
    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.metrics_dif == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.metrics_dif == true



- name: üöÄ TURBONOMIC - Deploy Synthetic Metrics Server for DIF
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üöÄ Deploy Synthetic Metrics Server for DIF"
    oc apply -f ./roles/ibm-turbonomic-demo-content/templates/create-data-ingestion.yaml
    echo ""
    echo ""
    export robotshopUUID=$(curl -XGET -s -k "https://{{TURBO_URL}}/api/v3/topologydefinitions" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json'|jq -r '.[]|select(.displayName=="RobotShopSynthetic").uuid')
    echo "  üåè Synthetic Metric URL: http://turbo-dif-service.default:3000/businessApplication/RobotShopSynthetic/$robotshopUUID"
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.metrics_dif == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.metrics_dif == true







- name: üöÄ TURBONOMIC - Create SyntheticMetricsHelloWorld
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create Hello Metrics"
    
    cat <<EOF | oc apply -f -
    ---
    # Source: turbodif/templates/configmap.yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: turbodif-config-turbodif-helloworld
      namespace: turbonomic
    data:
      turbodif-config.json: |-
        {
          "communicationConfig": {
            "serverMeta": {
              "version": "8.15.1",
              "turboServer": "https://nginx-turbonomic.apps.itz-jdly7v.osv.techzone.ibm.com"
            },
            "restAPIConfig": {
              "opsManagerUserName": "administrator",
              "opsManagerPassword": "P4ssw0rd!"
            }
          },
          "targetConfig": {
            "targetName": "SyntheticMetricsHelloWorld",
            "targetAddress": "http://turbo-metrics-dif-service.turbonomic:3000/helloworld"
          }
        }

    ---
    # Source: turbodif/templates/deployment.yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: turbodif-helloworld
      namespace: turbonomic-helloworld
      labels:
        app.kubernetes.io/name: turbodif-helloworld
        helm.sh/chart: turbodif-1.0.0
        app.kubernetes.io/instance: turbodif-helloworld
        app.kubernetes.io/managed-by: Helm
    spec:
      replicas: 1
      selector:
        matchLabels:
          app.kubernetes.io/name: turbodif-helloworld
          app.kubernetes.io/instance: turbodif-helloworld
      template:
        metadata:
          labels:
            app.kubernetes.io/name: turbodif-helloworld
            app.kubernetes.io/instance: turbodif-helloworld
        spec:
          containers:
            - name: turbodif-helloworld
              image: cp.icr.io/cpopen/turbonomic/turbodif:8.15.1
              imagePullPolicy: IfNotPresent
              args:
                - --v=2
                - --discovery-interval-sec=600
              volumeMounts:
              - name: turbodif-config
                mountPath: /etc/turbodif
                readOnly: true
              - name: turbonomic-credentials-volume
                mountPath: /etc/turbonomic-credentials
                readOnly: true
              - name: varlog
                mountPath: /var/log
          volumes:
          - name: turbodif-config
            configMap:
              name: turbodif-config-turbodif-helloworld
          - name: turbonomic-credentials-volume
            secret:
              defaultMode: 420
              optional: true
              secretName: "turbonomic-credentials"
          - name: varlog
            emptyDir: {}
          restartPolicy: Always
    EOF
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.metrics_dif == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.metrics_dif == true




- name: üöÄ TURBONOMIC - Create SyntheticMetricsRobotShop
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üì• Create RobotShop Metrics"
    export robotshopUUID=$(curl -XGET -s -k "https://{{TURBO_URL}}/api/v3/topologydefinitions" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json'|jq -r '.[]|select(.displayName=="RobotShopSynthetic").uuid')


    cat <<EOF | oc apply -f -
    ---
    # Source: turbodif/templates/configmap.yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: turbodif-config-turbodif
      namespace: turbonomic
    data:
      turbodif-config.json: |-
        {
          "communicationConfig": {
            "serverMeta": {
              "version": "8.15.1",
              "turboServer": "https://nginx-turbonomic.apps.itz-jdly7v.osv.techzone.ibm.com"
            },
            "restAPIConfig": {
              "opsManagerUserName": "administrator",
              "opsManagerPassword": "P4ssw0rd!"
            }
          },
          "targetConfig": {
            "targetName": "RobotShopSynthetic",
            "targetAddress": "http://turbo-metrics-dif-service.turbonomic:3000/businessApplication/RobotShopSynthetic/$robotshopUUID"
          }
        }

    ---
    # Source: turbodif/templates/deployment.yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: turbodif
      namespace: turbonomic
      labels:
        app.kubernetes.io/name: turbodif
        helm.sh/chart: turbodif-1.0.0
        app.kubernetes.io/instance: turbodif
        app.kubernetes.io/managed-by: Helm
    spec:
      replicas: 1
      selector:
        matchLabels:
          app.kubernetes.io/name: turbodif
          app.kubernetes.io/instance: turbodif
      template:
        metadata:
          labels:
            app.kubernetes.io/name: turbodif
            app.kubernetes.io/instance: turbodif
        spec:
          containers:
            - name: turbodif
              image: cp.icr.io/cpopen/turbonomic/turbodif:8.15.1
              imagePullPolicy: IfNotPresent
              args:
                - --v=2
                - --discovery-interval-sec=600
              volumeMounts:
              - name: turbodif-config
                mountPath: /etc/turbodif
                readOnly: true
              - name: turbonomic-credentials-volume
                mountPath: /etc/turbonomic-credentials
                readOnly: true
              - name: varlog
                mountPath: /var/log
          volumes:
          - name: turbodif-config
            configMap:
              name: turbodif-config-turbodif
          - name: turbonomic-credentials-volume
            secret:
              defaultMode: 420
              optional: true
              secretName: "turbonomic-credentials"
          - name: varlog
            emptyDir: {}
          restartPolicy: Always


    EOF

    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.metrics_dif == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.metrics_dif == true







# --------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------
# DEPLOY MEMORY AND CPU HOGS
# --------------------------------------------------------------------------------------------------------

- name: üöÄ TURBONOMIC - Deploy Memory and CPU Hogs
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üöÄ Deploy Memory and CPU Hogs"
    oc apply  -f ./roles/ibm-turbonomic-demo-content/templates/prime_numbers-deploy.yaml
    oc apply  -f ./roles/ibm-turbonomic-demo-content/templates/memory_grabber.yaml
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.resource_hogs == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.resource_hogs == true




# --------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------
# WEBHOOKS
# --------------------------------------------------------------------------------------------------------

- name: üöÄ TURBONOMIC - Sample Webhook
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " üöÄ Deploy Sample Webhook"

    result=$(curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/workflows" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' -d ' {
        "displayName": "My_WebHook",
        "className": "Workflow",
        "description": "My First Webhook",
        "discoveredBy":
        {
            "readonly": false
        },
       "type": "WEBHOOK",
       "typeSpecificDetails": {
       "url": "http://ibm.com",
          "method": "POST",
          "template": "My Webhook Template -- DATA: Action Details: $action.details",
          "type": "WebhookApiDTO"
       }
    }')

    echo $result
    echo ""
    echo ""
  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.metrics_dif == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.metrics_dif == true



- name: üíä CERTIFICATES - Patch Certificates for TechZone IPI/UPI
  shell: |
    CLUSTER_ROUTE=$(oc get routes console -n openshift-console | tail -n 1 2>&1 )
    CLUSTER_FQDN=$( echo $CLUSTER_ROUTE | awk '{print $2}')
    CLUSTER_NAME=${CLUSTER_FQDN##*console.}


    if [[ $CLUSTER_NAME =~ "cloud.techzone.ibm.com" ]];
    then
        echo "‚úÖ Seems that you're on Techzone IPI/UPI"  
        echo "‚úÖ Let's patch the certificates"  

        echo "Extracting signed cert"
        oc get secret -n openshift-ingress letsencrypt-certs -o jsonpath='{.data.tls\.crt}'| base64 -d > cert.crt
        oc get secret -n openshift-ingress letsencrypt-certs -o jsonpath='{.data.tls\.key}'| base64 -d > cert.key

        oc create secret tls -n turbonomic nginx-ingressgateway-certs --cert=cert.crt --key=cert.key --dry-run=client -o yaml | oc apply -f -


        REPLICAS=$(oc get pods -n turbonomic |grep nginx|wc -l |xargs)
        oc scale Deployment/nginx --replicas=0 -n turbonomic
        sleep 10
        oc scale Deployment/nginx --replicas=${REPLICAS} -n turbonomic
    else
        echo "‚úÖ Seems that you're NOT on Techzone IPI/UPI"  
        echo "‚úÖ No need to patch the certificates any further"  
    fi
  register: certificate_patch
  ignore_errors: true
  args:
    executable: /bin/bash
  when: current_feature.create_valid_ingress_itz | default(false) == true


- name: üü¢ DEBUG - Patch Certificates for TechZone IPI/UPI
  debug: 
    var: certificate_patch
  when: current_feature.create_valid_ingress_itz | default(false) == true



















- name: üöÄ TURBONOMIC - Create RobotShop Optimisation Automation
  shell: |
    curl -XPOST -s -k "https://{{TURBO_URL}}/api/v3/settingspolicies" -b /tmp/cookies  -H 'Content-Type: application/json;' -H 'accept: application/json' \
            -d '{
      "disabled": false,
      "entityType": "WorkloadController",
      "displayName": "RobotShop Automatic Optimization",
      "scopes": [{
          "uuid": "286812328290544"
      }],
      "settingsManagers": [{
          "uuid": "automationmanager",
          "displayName": "Action Mode Settings",
          "category": "Automation",
          "settings": [{
              "uuid": "resizeCPULimitUp",
              "value": "AUTOMATIC",
              "valueType": "STRING",
              "valueObjectType": "String",
              "defaultValue": "MANUAL",
              "entityType": "WorkloadController",
              "displayName": "VCPU Limit Resize up",
              "options": [{
                  "label": "Recommend",
                  "value": "RECOMMEND"
              }, {
                  "label": "External Approval",
                  "value": "EXTERNAL_APPROVAL"
              }, {
                  "label": "Manual",
                  "value": "MANUAL"
              }, {
                  "label": "Automatic",
                  "value": "AUTOMATIC"
              }]
          }, {
              "uuid": "resizeMemRequestDown",
              "value": "AUTOMATIC",
              "valueType": "STRING",
              "valueObjectType": "String",
              "defaultValue": "MANUAL",
              "entityType": "WorkloadController",
              "displayName": "VMEM Request Resize down",
              "options": [{
                  "label": "Recommend",
                  "value": "RECOMMEND"
              }, {
                  "label": "External Approval",
                  "value": "EXTERNAL_APPROVAL"
              }, {
                  "label": "Manual",
                  "value": "MANUAL"
              }, {
                  "label": "Automatic",
                  "value": "AUTOMATIC"
              }]
          }, {
              "uuid": "resizeMemLimitDown",
              "value": "AUTOMATIC",
              "valueType": "STRING",
              "valueObjectType": "String",
              "defaultValue": "MANUAL",
              "entityType": "WorkloadController",
              "displayName": "VMEM Limit Resize down",
              "options": [{
                  "label": "Recommend",
                  "value": "RECOMMEND"
              }, {
                  "label": "External Approval",
                  "value": "EXTERNAL_APPROVAL"
              }, {
                  "label": "Manual",
                  "value": "MANUAL"
              }, {
                  "label": "Automatic",
                  "value": "AUTOMATIC"
              }]
          }, {
              "uuid": "resizeMemLimitUp",
              "value": "AUTOMATIC",
              "valueType": "STRING",
              "valueObjectType": "String",
              "defaultValue": "MANUAL",
              "entityType": "WorkloadController",
              "displayName": "VMEM Limit Resize up",
              "options": [{
                  "label": "Recommend",
                  "value": "RECOMMEND"
              }, {
                  "label": "External Approval",
                  "value": "EXTERNAL_APPROVAL"
              }, {
                  "label": "Manual",
                  "value": "MANUAL"
              }, {
                  "label": "Automatic",
                  "value": "AUTOMATIC"
              }]
          }, {
              "uuid": "resizeCPURequestDown",
              "value": "AUTOMATIC",
              "valueType": "STRING",
              "valueObjectType": "String",
              "defaultValue": "MANUAL",
              "entityType": "WorkloadController",
              "displayName": "VCPU Request Resize down",
              "options": [{
                  "label": "Recommend",
                  "value": "RECOMMEND"
              }, {
                  "label": "External Approval",
                  "value": "EXTERNAL_APPROVAL"
              }, {
                  "label": "Manual",
                  "value": "MANUAL"
              }, {
                  "label": "Automatic",
                  "value": "AUTOMATIC"
              }]
          }, {
              "uuid": "resizeCPULimitDown",
              "value": "AUTOMATIC",
              "valueType": "STRING",
              "valueObjectType": "String",
              "defaultValue": "MANUAL",
              "entityType": "WorkloadController",
              "displayName": "VCPU Limit Resize down",
              "options": [{
                  "label": "Recommend",
                  "value": "RECOMMEND"
              }, {
                  "label": "External Approval",
                  "value": "EXTERNAL_APPROVAL"
              }, {
                  "label": "Manual",
                  "value": "MANUAL"
              }, {
                  "label": "Automatic",
                  "value": "AUTOMATIC"
              }]
          }]
      }]
    }'


    result=$(curl -s -k -X 'POST' \
      "https://{{TURBO_URL}}/api/v3/groups" -b /tmp/cookies\
      -H 'accept: application/json' \
      -H 'Content-Type: application/json' \
      -d '  
      {
        "displayName": "RobotShop Workload Controllers",
        "className": "Group",
        "groupType": "WorkloadController",
        "severity": "CRITICAL",
        "environmentType": "HYBRID",
        "isStatic": false,
        "logicalOperator": "AND",
        "criteriaList": [
      {
        "expVal": "robot-shop",
        "expType": "EQ",
        "filterType": "workloadControllersByNamespace",
        "caseSensitive": false,
        "entityType": null,
        "singleLine": false
      }
        ],
        "temporary": false,
        "cloudType": "UNKNOWN",
        "memberTypes": [
          "WorkloadController"
        ],
        "entityTypes": [
          "WorkloadController"
        ],
        "groupOrigin": "USER",
        "groupClassName": "GroupApiDTO"
      }
      ')

    echo $result


  ignore_errors: true
  register: output
  args:
    executable: /bin/bash
  when: current_feature.metrics_dif == true
- name: üü£  OUTPUT
  debug:
    var: output.stdout_lines
    verbosity: 1
  when: current_feature.metrics_dif == true

