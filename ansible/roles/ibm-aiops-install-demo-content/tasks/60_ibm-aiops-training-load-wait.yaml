

- name: ðŸ›°ï¸  START - WAIT FOR TRAINING DATA TO LOAD
  debug: 
    msg="{{ lookup('pipe','date +%d.%m.%Y---%H:%M:%S') }}"


- name: Log
  shell: |
    export MESSAGE="Wait for Training Data to finish loading"
    export currentDate=$(date +%Y-%m-%d_%H:%M)
    echo "---------------------------------------------------------------------------------------------------------------------------------------------------" >> ../install_{{current_ibmaiops_feature.kind}}.log
    echo $currentDate" - "$MESSAGE  >> ../install_{{current_ibmaiops_feature.kind}}.log
  ignore_errors: true

- name: ðŸ“£ OCP CONSOLE - Create Openshift NOTIFICATION
  shell: |
    cat <<EOF | oc apply -f -
    apiVersion: console.openshift.io/v1
    kind: ConsoleNotification
    metadata:
      name: ibm-aiops-notification
    spec:
      backgroundColor: '#ff7700'
      color: '#000'
      location: {{global_config.position_ocp_notifications | default("BannerTop")}}
      text: 'Installing {{current_ibmaiops_feature.kind}} - ðŸ•¦ Wait for Training Data to finish loading (up to 15 minutes) - Started at $(date +%H:%M) UTC'    
    EOF
  ignore_errors: true
  args:
    executable: /bin/bash
  when: global_config.create_ocp_notifications | default(true) == true  




- name: ðŸ•¦ TRAINING WAIT - WAIT FOR COMPLETION METRICS LOAD
  shell: |
    while : ; do
          READY=$(oc get jobs -n ibm-aiops-installer --ignore-not-found load-metric-cassandra)
          if [[ $READY  == "" ]]; then 
                break
          elif [[ ! $READY  =~ "1/1" ]]; then
                echo "        Load Job not completed. Waiting 10 seconds"
                sleep 10
          else
                break
          fi
    done
    echo "      âœ… OK"
  register: ES_READY
  args:
    executable: /bin/bash


# - name: ðŸ§» TRAINING WAIT - CLEANUP JOB METRICS LOAD
#   kubernetes.core.k8s:
#     state: absent
#     template: ./templates/training/load-job-metric.j2
  


# - name: ðŸ§» TRAINING WAIT - CLEANUP COMPLETED JOBS METRICS LOAD
#   shell: |
#     oc delete pod  -n ibm-aiops-installer --ignore-not-found $(oc get po -n ibm-aiops-installer|grep load-metric-cassandra|awk '{print$1}')
#   register: ES_READY
#   ignore_errors: true


- name: ðŸ•¦ TRAINING WAIT - WAIT FOR COMPLETION SNOW LOAD
  shell: |
      while : ; do
          READY=$(oc get jobs -n ibm-aiops-installer --ignore-not-found load-snow-indexes)
          if [[ $READY  == "" ]]; then 
                break
          elif [[ ! $READY  =~ "1/1" ]]; then
                echo "        Load Job not completed. Waiting 10 seconds"
                sleep 10
          else
                break
          fi
      done
      echo "      âœ… OK"
  register: ES_READY
  args:
    executable: /bin/bash


# - name: ðŸ§» TRAINING WAIT - CLEANUP JOB SNOW LOAD
#   kubernetes.core.k8s:
#     state: absent
#     template: ./templates/training/load-job-snow.j2
  


# - name: ðŸ§» TRAINING WAIT - CLEANUP COMPLETED JOBS SNOW LOAD
#   shell: |
#     oc delete pod  -n ibm-aiops-installer --ignore-not-found $(oc get po -n ibm-aiops-installer|grep load-snow-indexes|awk '{print$1}')
#   register: ES_READY
#   ignore_errors: true





- name: ðŸ•¦ TRAINING WAIT - WAIT FOR COMPLETION LAD LOAD
  shell: |
      while : ; do
          READY=$(oc get jobs -n ibm-aiops-installer --ignore-not-found load-lags-indexes)
          if [[ $READY  == "" ]]; then 
                break
          elif [[ ! $READY  =~ "1/1" ]]; then
                echo "        Load Job not completed. Waiting 10 seconds"
                sleep 10
          else
                break
          fi
      done
      echo "      âœ… OK"
  register: ES_READY
  args:
    executable: /bin/bash



