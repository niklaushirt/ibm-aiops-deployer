
# *************************************************************************************************************************************************
# --------------------------------------------------------------------------------------------------------------------------------------
# Install IBM Concert
# --------------------------------------------------------------------------------------------------------------------------------------
# *************************************************************************************************************************************************

# --------------------------------------------------------------------------------------------------------------------------------------
# Install IBM Concert
# --------------------------------------------------------------------------------------------------------------------------------------

- name: ğŸ›°ï¸  START - INSTALL IBM Concert
  debug: 
    msg="{{ lookup('pipe','date +%d.%m.%Y---%H:%M:%S') }}"


- name: Log
  shell: |
    export MESSAGE="Installing IBM Concert"
    export currentDate=$(date +%Y-%m-%d_%H:%M)
    echo "---------------------------------------------------------------------------------------------------------------------------------------------------" >> ../install_{{current_feature.kind}}.log
    echo $currentDate" - "$MESSAGE  >> ../install_{{current_feature.kind}}.log
  ignore_errors: true





- name: ğŸš€ IBM Concert - Set IBM Concert Password 
  set_fact: current_admin_pass={{global_config.global_password}}


- name: ğŸŸ£  IBM Concert -  IBM Concert Password {{current_admin_pass}}
  debug:
    var: current_admin_pass
    verbosity: 1






# --------------------------------------------------------------------------------------------------------------------------------------
# Getting Installation source from GitHub
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ğŸ“£ OCP CONSOLE - Create Openshift NOTIFICATION
  shell: |
    cat <<EOF | oc apply -f -
    apiVersion: console.openshift.io/v1
    kind: ConsoleNotification
    metadata:
      name: ibm-aiops-notification-status
    spec:
      backgroundColor: '#ffd500'
      color: '#000'
      location: {{global_config.position_ocp_notifications | default("BannerTop")}}
      text: 'Installing {{current_feature.kind}} - IBM Concert Getting Installation source from GitHub'    
    EOF
  ignore_errors: true
  args:
    executable: /bin/bash
  when: global_config.create_ocp_notifications | default(true) == true  





- name:   ğŸš€ IBM Concert - Getting Installation source from GitHub
  shell: |
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " ğŸš€ Getting Installation source from GitHub"
    echo "------------------------------------------------------------------------------------------------------------------------------"
    mkdir -p /tmp/
    cd  /tmp/

    wget https://github.com/IBM/Concert/releases/download/v2.2.0/ibm-concert-x86.tar.gz
    tar xfz ibm-concert-x86.tar.gz
    cd /tmp/ibm-concert
  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ğŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    #verbosity: 1






# --------------------------------------------------------------------------------------------------------------------------------------
# Prepare Installation
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ğŸ“£ OCP CONSOLE - Create Openshift NOTIFICATION
  shell: |
    cat <<EOF | oc apply -f -
    apiVersion: console.openshift.io/v1
    kind: ConsoleNotification
    metadata:
      name: ibm-aiops-notification-status
    spec:
      backgroundColor: '#ffd500'
      color: '#000'
      location: {{global_config.position_ocp_notifications | default("BannerTop")}}
      text: 'Installing {{current_feature.kind}} - IBM Concert Prepare Installation'    
    EOF
  ignore_errors: true
  args:
    executable: /bin/bash
  when: global_config.create_ocp_notifications | default(true) == true  



- name:   ğŸš€ IBM Concert - VARIABLES
  shell: |
    cd  /tmp/concert/ibm-concert
    echo ""
    echo ""
    echo ""
    echo ""
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " ğŸš€ Variables"
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo "USER                  : admin"
    echo "PASSWORD:             : {{ global_config.global_password }}"
    echo "ENTITLED_REGISTRY_KEY : $ENTITLED_REGISTRY_KEY"
    echo ""
    echo ""
    echo ""
    echo ""
  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ğŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    #verbosity: 1



- name:   ğŸš€ IBM Concert - Prepare Installation
  shell: |
  

    export INSTALL_DIR=/tmp/ibm-concert


    export OCP_URL=$(oc get Infrastructure cluster -o jsonpath={.status.apiServerURL})
    echo "OCP_URL: $OCP_URL"
    mv /tmp/ibm-concert/etc/params.ini /tmp/ibm-concert/etc/params.ini.all
    cat > /tmp/ibm-concert/etc/params.ini <<EOF
    
    # INSTALL_EKS: Set as True if installing on EKS
    INSTALL_EKS=false
    # This example is to install Hub, Concert, Data Apps and Workflows on a Kubernetes cluster.
    REG_USER={{ current_feature.prod_user }}
    IMAGE_REGISTRY_PREFIX={{ current_feature.prod_registry }}


    # ----- Hub Configuration -----

    # namespace for Hub
    HUB_NS={{ current_ibm_feature.project }}-hub
    HUB_IMAGE_REGISTRY_SUFFIX=/solis-hub
    SCALE_CONFIG_HUB=level_1
    # storage class for Hub
    STORAGE_CLASS_HUB={{ STORAGE_CLASS_FILE }}

    # ----- Concert Configuration -----

    INSTALL_CONCERT=true
    # namespace for Concert
    CONCERT_NS={{ current_ibm_feature.project }}
    CONCERT_IMAGE_REGISTRY_SUFFIX=/concert
    SCALE_CONFIG_CONCERT=level_1
    # storage class for Concert
    STORAGE_CLASS_CONCERT={{ STORAGE_CLASS_FILE }}

    # ----- Data Apps Configuration -----

    INSTALL_DATAAPPS=true
    # namespace for Data Apps
    DATAAPPS_NS={{ current_ibm_feature.project }}-dataapps
    DATAAPPS_IMAGE_REGISTRY_SUFFIX=/concert
    SCALE_CONFIG_DATAAPPS=level_1
    # storage class for Dataapps
    STORAGE_CLASS_DATAAPPS={{ STORAGE_CLASS_FILE }}

    # ----- Concert Workflow Configuration -----

    INSTALL_WORKFLOWS=true
    # namespace for Workflows
    WORKFLOWS_NS={{ current_ibm_feature.project }}-workflows
    # Domain name on which the application will listen
    # Example: solis-gw-workflows.apps.test.cp.my-domain.com
    WORKFLOWS_INSTANCE_ADDRESS=$OCP_URL
    EOF

    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " ğŸ› ï¸ Your Config File"
    echo "------------------------------------------------------------------------------------------------------------------------------"
    cat /tmp/ibm-concert/etc/params.ini
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo "------------------------------------------------------------------------------------------------------------------------------"

  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ğŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    #verbosity: 1



- name: ğŸ“£ OCP CONSOLE - Create Openshift NOTIFICATION
  shell: |
    cat <<EOF | oc apply -f -
    apiVersion: console.openshift.io/v1
    kind: ConsoleNotification
    metadata:
      name: ibm-aiops-notification-status
    spec:
      backgroundColor: '#ff7700'
      color: '#000'
      location: {{global_config.position_ocp_notifications | default("BannerTop")}}
      text: 'Installing {{current_feature.kind}} - ğŸ•¦ Wait for IBM Concert to become ready (about 60-80 minutes) - Started at $(date +%H:%M) UTC'    
    EOF
  ignore_errors: true
  args:
    executable: /bin/bash
  when: global_config.create_ocp_notifications | default(true) == true  



- name:   ğŸš€ IBM Concert -  Installation
  shell: |
    cd  /tmp/
    echo ""
    echo ""
    echo ""
    echo ""
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " ğŸš€ Start Concert Installation"
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo "/tmp/bin/setup --license_acceptance=y --username=admin --password={{ global_config.global_password }} --registry_password=$ENTITLED_REGISTRY_KEY"
    /tmp/ibm-concert/bin/setup --license_acceptance=y --username=admin --password={{ global_config.global_password }} --registry_password=$ENTITLED_REGISTRY_KEY



  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ğŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    #verbosity: 1



- name: ğŸ•¦ CHECK -  Wait for all Pods in {{ current_ibm_feature.project }} to become ready (this might take some time)
  shell: oc get pods -n ibm-concert -l app.kubernetes.io/name=ibm-concert|grep "Running"|grep "1/1"|wc -l| tr -d ' '
  register: kubectl_get_pods
  until: kubectl_get_pods.stdout|int > 17
  retries: 500
  delay: 15




- name:   ğŸš€ IBM Concert -  Finalize
  shell: |
    cd  /tmp/concert/ibm-concert
    echo ""
    echo ""
    echo ""
    echo ""
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " ğŸš€ Create Routes"
    echo "------------------------------------------------------------------------------------------------------------------------------"


    /tmp/ibm-concert/ibm-concert-k8s/ocp-route.sh {{ current_ibm_feature.project }}
    oc get route concert -n concert
    oc extract -n concert secret/app-cfg-secret --to=-

    /tmp/ibm-concert/ibm-concert-k8s/ocp-route.sh {{ current_ibm_feature.project }}-dataapps

  

    echo ""
    echo ""
    echo ""
    echo ""
    echo "------------------------------------------------------------------------------------------------------------------------------"
    echo " âœ… LOGINS"
    echo "------------------------------------------------------------------------------------------------------------------------------"
    

    export OCP_URL=$(oc get Infrastructure cluster -o jsonpath={.status.apiServerURL})
    export OCP_TOKEN=$(oc create token -n ibm-installer ibm-installer-admin --duration=999999999s)
    #export OCP_TOKEN=$(oc -n openshift-authentication get secret $(oc get secret -n openshift-authentication |grep -m1 oauth-openshift-token|awk '{print$1}') -o jsonpath='{.data.token}'|base64 --decode)
    echo "            ğŸŒ URL:               $OCP_URL"
    echo "            ğŸ«… User:              kubeadmin"
    echo "            ğŸ” Token:             $OCP_TOKEN"




  register: output_string
  ignore_errors: true
  args:
    executable: /bin/bash

- name: ğŸŸ£  OUTPUT
  debug: 
    var: output_string.stdout_lines
    #verbosity: 1



