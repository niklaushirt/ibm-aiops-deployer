#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#         ________  __  ___     ___    ________       
#        /  _/ __ )/  |/  /    /   |  /  _/ __ \____  _____
#        / // __  / /|_/ /    / /| |  / // / / / __ \/ ___/
#      _/ // /_/ / /  / /    / ___ |_/ // /_/ / /_/ (__  ) 
#     /___/_____/_/  /_/    /_/  |_/___/\____/ .___/____/  
#                                           /_/
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------"
#  Installing IBM AIOps
#
#  IBM AIOps
#
#  Â©2023 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Installs:
#
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
 

- hosts: localhost
  #become: true
  #vars_files: {{ config_file }}
  #vars_files: ./configs/ibmaiops-roks-all.yaml

  tasks:
  - name: ðŸš€ MAIN INSTALLATION LOOP - Install Module
    debug: 
      msg: 
      - "***************************************************************************************************************************************************"
      - "***************************************************************************************************************************************************"
      - "***************************************************************************************************************************************************"
      - "***************************************************************************************************************************************************"
      - "                                                                                                                                                   "
      - "       ðŸŸ¢ðŸŸ¢ðŸŸ¢ IBM AIOps - INSTALLATION -  CUSTOM INSTALLATION                                                                      "
      - "                                                                                                                                                   "
      - "***************************************************************************************************************************************************"
      - "***************************************************************************************************************************************************"
      - "***************************************************************************************************************************************************"
      verbosity: 2

  - name: ðŸ“£ OCP CONSOLE - Create Openshift NOTIFICATION
    shell: |
      cat <<EOF | oc apply -f -
      apiVersion: console.openshift.io/v1
      kind: ConsoleNotification
      metadata:
        name: ibmaiops-notification-main
      spec:
        backgroundColor: '#141a6b'
        color: '#fff'
        location: {{global_config.position_final_ocp_notification | default("BannerTop")}}
        text: 'Starting Installation - Warming Up'
      EOF
    ignore_errors: true


  - name: ðŸ› ï¸  Config File Path
    debug:
      var: config_file_path
      verbosity: 2

  - name: ðŸ› ï¸  Ansible check config file exists
    stat:
      path: "{{config_file_path}}"
    register: p

  - name: ðŸ› ï¸  Ansible check config file exists
    debug:
      msg: "  âœ… Config File exists..."
      verbosity: 2
    when: p.stat.exists

  - name: ðŸ› ï¸  Fail if not exists
    fail: msg="The specified config file {{config_file_path}} does not exist"
    when: p.stat.exists == False
      
  - name: ðŸ› ï¸  Import Config File
    include_vars:
      file: "{{config_file_path}}"
      name: all_config

  - name: ðŸŸ¢ðŸŸ¢ðŸŸ¢  Show Config File
    debug:
      var: all_config


  - name: ðŸ› ï¸  Get Global Config
    set_fact: global_config={{ all_config.global_config | default([]) }}
  - name: ðŸŸ¢ðŸŸ¢ðŸŸ¢  Show Global Config
    debug:
      var: global_config


  - name: ðŸ› ï¸  Get Openshift Config
    set_fact: openshift_cluster={{ all_config.openshift | default([]) }}
  - name: ðŸŸ¢ðŸŸ¢ðŸŸ¢  Show Openshift Config
    debug:
      var: openshift_cluster


  - name: ðŸ“£ OCP CONSOLE - Create Openshift NOTIFICATION
    shell: |
      cat <<EOF | oc apply -f -
      apiVersion: console.openshift.io/v1
      kind: ConsoleNotification
      metadata:
        name: ibmaiops-notification
      spec:
        backgroundColor: '#009a00'
        color: '#fff'
        link:
          href: "https://$appURL"
          text: DemoUI
        location: {{global_config.position_ocp_notifications | default("BannerTop")}}
        text: "Caaaaaater. Access the DemoUI with Password here:"
      EOF
    ignore_errors: true

